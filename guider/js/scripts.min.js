$(document).ready(function() {
	var arrLunbotu = [];
	
	$(".demo, .demo .column").sortable({
		connectWith: ".column",
		opacity: .35,
		handle: ".drag"
	});
	
	//左侧模块拖动到右侧
	$(".module-list .lyrow").draggable({ connectToSortable:".demo", helper:"clone", handle:".drag",
		drag:function(e,t){
			t.helper.width(63);
		},
		stop:function(e,t){
			var zhi = $(this).hasClass('lunbotu');
			var mode = $(this).data("mode");
			
			$(".demo *[data-mode=" + mode + "]").each(function(index, element) {
				$(this).attr("data-diff",index);
			});
			if(zhi){
				var lunbotu = $(".demo").find('.lunbotu');
				arrLunbotu.push(t.position.top);
				if(arrLunbotu.length == 1){
					if(arrLunbotu[0] > arrLunbotu[1]){
						lunbotu.eq(0).remove();
					}else{
						lunbotu.eq(1).remove();
					}
					arrLunbotu.pop();
				}
				if(lunbotu.length > 1){
					layer.msg('轮播图模块只能使用一次',{time:500,offset:["50%","50%"]});
				}else{
					if(t.position.left>300){
						layer.msg('添加成功',{time:500,offset:["50%","50%"]});
						disabled();
					}
				}
			}else{
				if(t.position.left>300){
					layer.msg('添加成功',{time:500,offset:["50%","50%"]});
					disabled();
				}
			}
		}
	});
	
	//模块上移
	$(document).on("click",".move-up",function(){
		var _this = $(this);
		var _div = _this.parents(".item");
		var prev_div = _div.prev();
		
		var clone = _div.clone();
		if(!_this.hasClass("disabled")){
			_div.remove();
			prev_div.before(clone);
			visual();
			disabled();
		}
	});
	
	//模块下移
	$(document).on("click",".move-down",function(){
		var _this = $(this);
		var _div = _this.parents(".item");
		var next_div = _div.next();
		
		var clone = _div.clone();
		if(!_this.hasClass("disabled")){
			_div.remove();
			next_div.after(clone);
			visual();
			disabled();
		}
	});
	
	//判断模块是顶部模块或底部模块
	function disabled(){
		var demo = $(".demo");
		demo.find(".item .move-up").removeClass("disabled");
		demo.find(".item:first .move-up").addClass("disabled");
		
		demo.find(".item .move-down").removeClass("disabled");
		demo.find(".item:last .move-down").addClass("disabled");
	}
	
	//删除模块
	function removeElm() {
		$(".demo").delegate(".move-remove", "click", function(e) {
			that = $(this);
			layer.confirm('您确定要删除这个模块吗？', {
				btn: ['确定','取消'],
			}, function(){
				time: 500,
				layer.msg('删除成功',{time:500,offset:["50%","50%"]}),
				e.preventDefault();
				that.parents(".item").remove();
				disabled();
				visual();
				if (!$(".demo .lyrow").length > 0) {
					clearDemo();
				}
			});
		})
	}
	removeElm();
	
	//判断模块是否存在
	function clearDemo() {
		if( $(".demo").html() == "" ){
			layer.msg('当前没有任何模板哦',{time:500,offset:["50%","50%"]})
		}else{
			layer.confirm('您确定要清空所有模块吗？', {
				btn: ['确定','取消'],
			}, function(){
				time: 500,
				layer.msg('清空成功',{time:500,offset:["50%","50%"]}),
				$(".demo").empty();
			});
		}
	}
});

jQuery.upload_file = function(file,url,showImg,fn){
	$(file).change(function(){
		var _this = $(this);
		var actionUrl = url;
		var form = _this.parents("form");
		var hiddenInput = form.find("input[name='fileimg']");
		form.ajaxSubmit({
			type: "POST",
			dataType: "json",
			url: actionUrl,
			data: { "action": "TemporaryImage" },
			success: function (data) {
				if (data.error == "1") {
				   alert(data.prompt);
				}else if(data.error == "2") {
					if(showImg != ""){		
						$(showImg).attr('src',data.content); 
					}
					hiddenInput.val(data.content);
					if(fn){
						fn(_this,data.content);
					} 
				}
			},
			async: true
		});
	});
};
